#!/bin/sh
set -e

. "$(git --exec-path)/git-sh-setup"
cd_to_toplevel

export GIT_INDEX_FILE="$GIT_DIR/index.sepia-keys"

rm -f -- "$GIT_INDEX_FILE"

find ssh -name '*.pub' -a \! -name '@*' -type f -print0 \
| git update-index --add --replace -z --stdin

ALL_SHA1="$(
  find ssh/ -name '*.pub' -a \! -name '@*' -exec cat '{}' + \
  | sort \
  | git hash-object -t blob -w --stdin --no-filters
)"

git update-index --add \
    --cacheinfo 100644 "$ALL_SHA1" ssh/@all.pub

TREE="$(git write-tree)"

COMMIT="$(git commit-tree "$TREE" <<EOF
Regenerated keys.
EOF
)"
git update-ref -m 'Regenerated keys' refs/heads/autogenerated "$COMMIT"

REMOTE="$(git config --get branch.main.remote)"
git push -- "$REMOTE" +autogenerated
